<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Writing expressive unit test with injected dependancy</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">A web log </a></h1>
                <nav><ul>
                    <li><a href="/pages/about-me.html">About me</a></li>
                    <li class="active"><a href="/category/web-log.html">Web log</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/writing-expressiv-unit-test-injected-dependancy.html" rel="bookmark"
           title="Permalink to Writing expressive unit test with injected dependancy">Writing expressive unit test with injected dependancy</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-04-09T22:54:23+02:00">
                Published: Thu 09 April 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/felix-delval.html">FÃ©lix Delval</a>
        </address>
<p>In <a href="/category/web-log.html">Web log</a>. </p>
<p>tags: <a href="/tag/xunit.html">xUnit</a> <a href="/tag/php.html">php</a> <a href="/tag/expressiveness.html">expressiveness</a> </p>
</footer><!-- /.post-info -->      <p>Recently I have been facing problem writing maintainable unit test for code that
is relying heavily on injected dependancy.</p>
<p>Sometimes you are facing code that is using multiple injected dependancies that should
all be mocked for testing purpose. Mocking is a very effective pattern to test part of
a system in isolation. Though when the unit test code is mock intensive it begins to be
hard to understand, maintain and serve it first purpose help us in refactoring.</p>
<p>Here is a pattern I found usefull to solve this issue.</p>
<p>Let's take the example of an class and a interface it uses as a dependancy. Here is the interface:</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">interface</span> <span class="nx">CassetteInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">read</span><span class="p">();</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">isOver</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<p>And here the class that uses it :</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">CassettePlayer</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$cassette</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">CassetteInterface</span> <span class="nv">$cassette</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassette</span> <span class="o">=</span> <span class="nv">$cassette</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">playAndRewind</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassette</span><span class="o">-&gt;</span><span class="na">isOver</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassette</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassette</span><span class="o">-&gt;</span><span class="na">rewind</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>If you would go writing test for this class, once all code as written, you would
most likely start writing a test like this :</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">CassettePlayerTest</span> <span class="nx">extend</span> <span class="nx">TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nx">testPlayLoop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$cassette</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMock</span><span class="p">(</span><span class="s1">&#39;CassetteInterface&#39;</span><span class="p">);</span>

        <span class="nv">$cassette</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;play&#39;</span><span class="p">);</span>
        <span class="nv">$cassette</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;rewind&#39;</span><span class="p">);</span>

        <span class="nv">$player</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CassettePlayer</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassette</span><span class="p">);</span>

        <span class="nv">$player</span><span class="o">-&gt;</span><span class="na">playAndRewind</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Writing the unit test for this class in such a manner leads to complex unit test
code that is not maintanable and harder to read. Even though the code is short,
the way the mock is around leads to complex formulation, more so when you start
setting the expecting parameters and the desired output.</p>
<p>Let's try to restructure the test so it is a bit more modular and reusable.</p>
<p>I like doing the instantiation of the mock in private properties inside
of the <code>TestCase::setUp</code> method. It gives two big advantages.</p>
<p>Firstly the mock dependancies declaration needs to be in only one place, 
making sure that all your tests are using the same objects.</p>
<p>Secondly using them in a property, makes it easy to extract the behaviour definition of the
mock to a method without parameters, creating easily readable and reusable behavioural
methods.</p>
<p>Here is how it would end :</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">CassettePlayerTest</span> <span class="nx">extend</span> <span class="nx">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$cassette</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassette</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMock</span><span class="p">(</span><span class="s1">&#39;CassetteInterface&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nx">testPlayLoop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassetteWillBePlayed</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassetteWillBeRewind</span><span class="p">();</span>

        <span class="nv">$player</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CassettePlayer</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassette</span><span class="p">);</span>

        <span class="nv">$player</span><span class="o">-&gt;</span><span class="na">playAndRewind</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">cassetteWillBePlayed</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassette</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;play&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">cassetteWillBeRewind</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cassette</span><span class="o">-&gt;</span><span class="na">expects</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">once</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">&#39;rewind&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/fe_lix_">Twitter</a></li>
                            <li><a href="http://es.linkedin.com/in/felixdelval/">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>